---
title: Server Services
sidebar_position: 4
---

# Server Services

The Server's business logic is organized into modular service classes and functions.

## Service Organization

### RAG Services (`/services/rag/`)

| Service | Purpose | Key Methods |
|---------|---------|-------------|
| **SourceManagementService** | Manage knowledge sources | `get_available_sources()`, `delete_source()` |
| **CrawlingService** | Web crawling operations | `crawl_single_page()`, `crawl_batch_with_progress()`, `crawl_recursive_with_progress()` |
| **DocumentStorageService** | Document chunking & storage | `smart_chunk_markdown()`, `extract_section_info()` |
| **SearchService** | Vector search operations | `search_documents()`, `search_code_examples()` |

### Project Services (`/services/projects/`)

| Service | Purpose | Key Methods |
|---------|---------|-------------|
| **ProjectService** | Project CRUD operations | `create_project()`, `get_project()`, `update_project()`, `delete_project()` |
| **TaskService** | Task management | `create_task()`, `update_task_status()`, `get_tasks_by_project()` |
| **DocumentService** | Project documents | `add_document()`, `get_documents()`, `update_document()` |
| **VersioningService** | JSONB field versioning | `create_version()`, `get_versions()`, `restore_version()` |

### Core Services (`/services/`)

| Service | Purpose | Key Methods |
|---------|---------|-------------|
| **CredentialService** | Secure credential storage | `get_credential()`, `set_credential()` |
| **PromptService** | AI prompt management | `get_prompt()`, `reload_prompts()` |
| **ThreadingService** | Threading & rate limiting | `batch_process()`, `rate_limited_operation()` |
| **MCPServiceClient** | HTTP client for MCP | `crawl_url()`, `search()`, `delete_source()` |

### Storage Functions (`/services/storage/`)

| Module | Key Functions |
|--------|---------------|
| **document_storage_service.py** | `add_documents_to_supabase()`, `add_documents_to_supabase_parallel()` |
| **code_storage_service.py** | `extract_code_blocks()`, `add_code_examples_to_supabase()` |

### Embedding Functions (`/services/embeddings/`)

| Module | Key Functions |
|--------|---------------|
| **embedding_service.py** | `create_embeddings_batch()`, `create_embeddings_batch_async()` |
| **contextual_embedding_service.py** | `generate_contextual_embedding()`, `generate_contextual_embeddings_batch()` |

## Service Usage Patterns

### Direct Service Usage (FastAPI)
```python
from ..services.rag.source_management_service import SourceManagementService

@router.delete("/sources/{source_id}")
async def delete_source(source_id: str):
    service = SourceManagementService(get_supabase_client())
    success, result = service.delete_source(source_id)
    return {"success": success, **result}
```

### HTTP Service Usage (MCP)
```python
async def delete_source(ctx: Context, source: str) -> str:
    async with httpx.AsyncClient() as client:
        response = await client.delete(f"{API_URL}/api/sources/{source}")
        return response.json()
```

### Direct Socket.IO Emission Pattern
```python
from ..socketio.progress_utils import update_crawl_progress

async def crawl_with_progress(url: str, progress_id: str):
    crawling_service = CrawlingService(crawler, supabase_client)
    
    # Services emit Socket.IO events directly - no callback chains
    await update_crawl_progress(progress_id, {
        'status': 'crawling',
        'percentage': 10,
        'log': f'Starting crawl of {url}'
    })
    
    results = await crawling_service.crawl_batch_with_progress(
        urls=[url],
        progress_id=progress_id  # Services emit directly
    )
    return results
```

## Key Service Features

### Simplified Real-Time Communication

**Architecture Changes:**
- **No database polling** - Eliminated 2-second polling system that checked for task/project changes
- **Direct Socket.IO emission** - Services emit events directly to Socket.IO rooms
- **No callback chains** - Removed complex progress callback functions
- **Room-based targeting** - Updates sent to specific rooms (project_id, progress_id)
- **Single communication method** - Only Socket.IO, removed dual WebSocket/Socket.IO systems

**Socket.IO Integration:**
```python
# Services import and use Socket.IO directly
from ..socketio_app import get_socketio_instance, NAMESPACE_TASKS
from ..socketio.progress_utils import update_crawl_progress

sio = get_socketio_instance()

# Direct emission to rooms
await sio.emit('task_updated', task_data, room=project_id, namespace=NAMESPACE_TASKS)
await update_crawl_progress(progress_id, {'status': 'processing', 'percentage': 50})
```

### Threading Service
- Rate limiting for OpenAI API (200k tokens/min)
- Thread pools for CPU and I/O operations
- WebSocket-safe batch processing
- System metrics monitoring

### Credential Service
- Encrypted credential storage
- Category-based organization
- Runtime caching for performance
- Environment variable compatibility

### Document Storage
- Parallel document processing
- Progress reporting via callbacks
- Automatic embedding generation
- Batch operations for efficiency

## Service Dependencies

```
FastAPI Endpoints
    ↓
Service Classes (SourceManagementService, etc.)
    ↓
Service Functions (add_documents_to_supabase, etc.)
    ↓
Database (Supabase) / External APIs (OpenAI)
```

## Configuration

Services are configured via environment variables:
- `SUPABASE_URL` - Database URL
- `SUPABASE_SERVICE_KEY` - Database service key
- `OPENAI_API_KEY` - For embeddings
- `LOGFIRE_TOKEN` - For monitoring

All services use dependency injection for testability and flexibility.